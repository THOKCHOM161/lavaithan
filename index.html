
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4A90E2">
    <title>Sohaib Mobile</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2965/2965300.png">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
</head>
<body>
    <div id="app">
        <header>
            <div class="app-title">Sohaib Mobile</div>
            <div class="hamburger-menu" id="hamburger-menu">&#9776;</div>
        </header>

        <nav id="side-nav" class="side-nav">
            <a href="#" class="close-btn" id="close-side-nav">&times;</a>
            <a href="#" id="side-nav-admin">Admin Login</a>
            <a href="#" id="side-nav-about">About Developer</a>
            <a href="#" id="side-nav-logout" style="display: none;">Logout</a>
        </nav>

        <!-- Loading overlay -->
        <div id="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Processing your request...</p>
        </div>

        <!-- Success popup -->
        <div id="success-popup" class="popup" style="display: none;">
            <div class="popup-content">
                <span class="popup-close" id="close-popup">&times;</span>
                <p id="popup-message"></p>
            </div>
        </div>

        <div id="auth-page" class="page">
            <div class="card auth-card">
                <div id="register-section">
                    <h2>Register</h2>
                    <input type="text" id="register-username" placeholder="Username">
                    <input type="email" id="register-email" placeholder="Email">
                    <input type="password" id="register-password" placeholder="Password">
                    <button id="register-btn">Register</button>
                    <p class="switch-auth">Already have an account? <span class="link" id="show-login">Login here</span></p>
                </div>
                <div id="login-section" style="display: none;">
                    <h2>Login</h2>
                    <input type="email" id="login-email" placeholder="Email">
                    <input type="password" id="login-password" placeholder="Password">
                    <button id="login-btn">Login</button>
                    <p class="switch-auth">New user? <span class="link" id="show-register">Register here</span></p>
                </div>
            </div>
        </div>

        <div id="welcome-page" class="page" style="display: none;">
            <div class="card welcome-card">
                <h1>Welcome to Sohaib Mobile!</h1>
                <div style="text-align: center; margin: 15px 0;">
                    <a href="#about-page" onclick="document.getElementById('about-page').style.display='block'; document.getElementById('welcome-page').style.display='none';" 
                       style="display: inline-block;
                              padding: 10px 25px;
                              color: #3498db;
                              text-decoration: none;
                              font-weight: 500;
                              border: 2px solid #3498db;
                              border-radius: 30px;
                              transition: all 0.3s ease;
                              position: relative;
                              overflow: hidden;">
                        <span style="position: relative; z-index: 2;">Know Me</span>
                        <span style="position: absolute;
                                    top: 0;
                                    left: -100%;
                                    width: 100%;
                                    height: 100%;
                                    background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.2), transparent);
                                    transition: all 0.5s ease;
                                    z-index: 1;"></span>
                    </a>
                </div>
                <div class="image-slider-container">
                    <img id="slider-image" src="download.webp" alt="Loan Promotion">
                </div>
                <div class="loan-options">
                    <div class="loan-card" id="youth-business-loan">
                        <h3>Youth Business Loan</h3>
                        <p>Start or grow your business today!</p>
                    </div>
                    <div class="loan-card" id="apna-ghar-apni-chat-loan">
                        <h3>Apna Ghar Apni Chat Loan</h3>
                        <p>Your dream home is within reach!</p>
                    </div>
                </div>
            </div>
        </div>

       <div id="youth-loan-page" class="page" style="display: none;">
    <div class="card">
        <h2>Youth Business Loan Application</h2>
        <form id="youth-loan-form" onsubmit="event.preventDefault(); document.getElementById('youth-loan-success-popup').style.display='block';">
            <label for="youth-cnic-front">CNIC Front:</label>
            <input type="file" id="youth-cnic-front" accept="image/*" required>

            <label for="youth-cnic-back">CNIC Back:</label>
            <input type="file" id="youth-cnic-back" accept="image/*" required>

            <label for="youth-applicant-pic">Applicant Photo:</label>
            <input type="file" id="youth-applicant-pic" accept="image/*" required>

            <label for="youth-education">Education:</label>
            <input type="text" id="youth-education" placeholder="Highest Education" required>

            <label for="youth-work">Work Experience:</label>
            <input type="text" id="youth-work" placeholder="Job Title / Business Type" required>

            <label for="youth-mobile">Mobile Number:</label>
            <input type="tel" id="youth-mobile" placeholder="e.g., 03XX-XXXXXXX" required>

            <label for="youth-cnic-number">CNIC Number (for tracking):</label>
            <input type="text" id="youth-cnic-number" placeholder="e.g., XXXXX-XXXXXXX-X" required>

            <button type="submit">Submit Application</button>
        </form>
    </div>

    <!-- Success Popup (initially hidden) -->
    <div id="youth-loan-success-popup" style="
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #4CAF50;
        color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        z-index: 1000;
        text-align: center;
        max-width: 80%;
        width: 300px;
    ">
        <h3 style="margin-top: 0;">Success!</h3>
        <p>Your application has been submitted successfully.</p>
        <button onclick="document.getElementById('youth-loan-success-popup').style.display='none'" style="
            background-color: white;
            color: #4CAF50;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
        ">OK</button>
    </div>
</div>

        <div id="ghar-loan-page" class="page" style="display: none;">
    <div class="card">
        <h2>Apna Ghar Apni Chat Loan Application</h2>
        <form id="ghar-loan-form" onsubmit="event.preventDefault(); document.getElementById('ghar-loan-success-popup').style.display='block';">
            <label for="ghar-cnic-front">Applicant CNIC Front:</label>
            <input type="file" id="ghar-cnic-front" accept="image/*" required>

            <label for="ghar-cnic-back">Applicant CNIC Back:</label>
            <input type="file" id="ghar-cnic-back" accept="image/*" required>

            <label for="ghar-relative-cnic-front">Husband/Father/Wife CNIC Front:</label>
            <input type="file" id="ghar-relative-cnic-front" accept="image/*" required>

            <label for="ghar-mobile1">Mobile Number 1:</label>
            <input type="tel" id="ghar-mobile1" placeholder="e.g., 03XX-XXXXXXX" required>

            <label for="ghar-mobile2">Mobile Number 2:</label>
            <input type="tel" id="ghar-mobile2" placeholder="e.g., 03XX-XXXXXXX">

            <label for="ghar-plot-registry">Plot Registry:</label>
            <input type="file" id="ghar-plot-registry" accept="image/*" required>

            <label for="ghar-cnic-number">CNIC Number (for tracking):</label>
            <input type="text" id="ghar-cnic-number" placeholder="e.g., XXXXX-XXXXXXX-X" required>

            <button type="submit">Submit Application</button>
        </form>
    </div>

    <!-- Success Popup (initially hidden) -->
    <div id="ghar-loan-success-popup" style="
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #4CAF50;
        color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        z-index: 1000;
        text-align: center;
        max-width: 80%;
        width: 300px;
    ">
        <h3 style="margin-top: 0;">Success!</h3>
        <p>Your Apna Ghar Apni Chat loan application has been submitted successfully.</p>
        <button onclick="document.getElementById('ghar-loan-success-popup').style.display='none'" style="
            background-color: white;
            color: #4CAF50;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
        ">OK</button>
    </div>
</div>

        <div id="tracker-page" class="page" style="display: none;">
            <div class="card">
                <h2>Application Tracker</h2>
                <input type="text" id="tracker-cnic" placeholder="Enter your CNIC Number">
                <button id="tracker-search-btn">Search Application</button>
                <div id="tracker-results"></div>
            </div>
        </div>

        <div id="analytics-page" class="page" style="display: none;">
            <div class="card">
                <h2>Analytics & Feedback</h2>
                <p>App Views: <span id="app-views">0</span></p>
                <p>App Likes: <span id="app-likes">0</span> <button id="like-btn">Like this App</button></p>
                <div>
                    <h3>Rate this App:</h3>
                    <div class="stars" id="rating-stars">
                        <span class="star" data-value="1">&#9733;</span>
                        <span class="star" data-value="2">&#9733;</span>
                        <span class="star" data-value="3">&#9733;</span>
                        <span class="star" data-value="4">&#9733;</span>
                        <span class="star" data-value="5">&#9733;</span>
                    </div>
                    <p class="rating-display">Your Rating: <span id="user-rating-display">Not Rated</span></p>
                </div>
                <h3>Feedback:</h3>
                <textarea id="feedback-text" rows="5" placeholder="Share your thoughts..."></textarea>
                <button id="submit-feedback-btn">Submit Feedback</button>
                <div id="feedback-status"></div>
            </div>
        </div>

        <div id="eligibility-page" class="page" style="display: none;">
            <div class="card">
                <h2>Eligibility Criteria</h2>
                <h3>Youth Business Loan:</h3>
                <p>A small business idea or existing small work is needed. Must be a Pakistani citizen and meet age requirements.</p>
                <h3>Apna Ghar Apni Chat Loan:</h3>
                <p>Ownership of a plot (plot registry needed). Must be a Pakistani citizen and meet financial eligibility.</p>
            </div>
        </div>

        <div id="about-page" class="page" style="display: none;">
            <div class="card">
                <div class="about-header">
                    <img src="https://i.imgur.com/Jf6yJ4W.jpg" alt="Developer Photo" class="developer-photo">
                    <h2>Sohaib Mobile</h2>
                    <p class="developer-title">Loan Application Developer</p>
                </div>
                
                <div class="about-section">
                    <h3><i class="fas fa-user"></i> About Me</h3>
                    <p>Hello! I'm the developer behind this loan application platform. With 3+ years of experience in fintech solutions, I've built this app to simplify the loan application process for Pakistani citizens.</p>
                </div>
                <div class="about-section" style="
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 400px;
    margin: 20px auto;
">
    <h3 style="
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 22px;
        border-bottom: 2px solid #3498db;
        padding-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
    ">
        <i class="fas fa-mobile-alt" style="color: #3498db;"></i> Contact Us
    </h3>
    
    <a href="https://wa.me/923434530019" style="
        display: block;
        background-color: #25D366;
        color: white;
        padding: 12px 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        font-weight: 500;
    " class="contact-link whatsapp" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'" 
    onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'">
        <i class="fab fa-whatsapp" style="margin-right: 10px; font-size: 18px;"></i> WhatsApp: 03434530019
    </a>
    
    <a href="mailto:sohaibmobile@example.com" style="
        display: block;
        background-color: #3498db;
        color: white;
        padding: 12px 15px;
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        font-weight: 500;
    " class="contact-link email" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'" 
    onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'">
        <i class="fas fa-envelope" style="margin-right: 10px; font-size: 18px;"></i> Email: sohaibmobile@example.com
    </a>
</div>
                
                <div class="about-section">
                    <h3><i class="fas fa-lock"></i> Privacy Commitment</h3>
                    <p>Your data security is my top priority. All information is encrypted and never shared with third parties.</p>
                </div>
            </div>
        </div>

        <div id="admin-login-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-button" id="close-admin-modal">&times;</span>
                <h2>Admin Login</h2>
                <input type="password" id="admin-password-input" placeholder="Admin Password">
                <button id="admin-login-btn">Login</button>
                <p id="admin-login-error" class="error-message" style="display: none;"></p>
            </div>
        </div>

        <div id="admin-page" class="page" style="display: none;">
            <div class="card">
                <h2>Admin Panel</h2>
                <div id="admin-applications"></div>
                <button id="admin-logout-btn">Logout Admin</button>
            </div>
        </div>

        <div class="footer" id="footer-nav" style="display: none;">
            <div class="footer-item" id="nav-welcome">
                <i class="fas fa-home"></i>
                <span>Welcome</span>
            </div>
            <div class="footer-item" id="nav-eligibility">
                <i class="fas fa-check-circle"></i>
                <span>Eligibility</span>
            </div>
            <div class="footer-item" id="nav-analytics">
                <i class="fas fa-chart-bar"></i>
                <span>Analytics</span>
            </div>
            <div class="footer-item" id="nav-tracker">
                <i class="fas fa-search-location"></i>
                <span>Tracker</span>
            </div>
        </div>
    </div>

    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Install Prompt
        let deferredPrompt;
        const installBtn = document.createElement('button');
        installBtn.id = 'installBtn';
        installBtn.className = 'install-btn';
        installBtn.textContent = 'Install App';
        installBtn.style.display = 'none';
        document.body.appendChild(installBtn);
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
            
            installBtn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                    installBtn.style.display = 'none';
                });
            });
        });

        window.addEventListener('appinstalled', () => {
            installBtn.style.display = 'none';
            console.log('PWA was installed');
        });

        window.addEventListener('load', () => {
            if (window.matchMedia('(display-mode: standalone)').matches) {
                installBtn.style.display = 'none';
            }
        });
// Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB3uXd_gn5WuL0t0gv0Qyt_c7iIgeXV9mc",
    authDomain: "hati-4707b.firebaseapp.com",
    projectId: "hati-4707b",
    databaseURL: "https://hati-4707b-default-rtdb.firebaseio.com/",
    storageBucket: "hati-4707b.firebasestorage.app",
    messagingSenderId: "209757591816",
    appId: "1:209757591816:web:c0f06a5829143f75d074bd"
  };
  
// Cloudinary Configuration
const CLOUDINARY_CLOUD_NAME = 'dtbftpnkq';
const CLOUDINARY_API_KEY = '543627576256858';
const CLOUDINARY_UPLOAD_PRESET = 'Lavaithan';
const CLOUDINARY_API_SECRET = 'wtkB1cxJypNvO3CguCb-NsGy7bk'; 

// Admin password
const ADMIN_PASSWORD = 'Lavaithan';

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const storage = firebase.storage();

// --- DOM Elements ---
const appDiv = document.getElementById('app');
const authPage = document.getElementById('auth-page');
const registerSection = document.getElementById('register-section');
const loginSection = document.getElementById('login-section');
const registerUsernameInput = document.getElementById('register-username');
const registerEmailInput = document.getElementById('register-email');
const registerPasswordInput = document.getElementById('register-password');
const registerBtn = document.getElementById('register-btn');
const showLoginLink = document.getElementById('show-login');
const loginEmailInput = document.getElementById('login-email');
const loginPasswordInput = document.getElementById('login-password');
const loginBtn = document.getElementById('login-btn');
const showRegisterLink = document.getElementById('show-register');

const welcomePage = document.getElementById('welcome-page');
const sliderImage = document.getElementById('slider-image');
const youthBusinessLoanCard = document.getElementById('youth-business-loan');
const apnaGharApniChatLoanCard = document.getElementById('apna-ghar-apni-chat-loan');

const youthLoanPage = document.getElementById('youth-loan-page');
const youthLoanForm = document.getElementById('youth-loan-form');
const youthCnicFrontInput = document.getElementById('youth-cnic-front');
const youthCnicBackInput = document.getElementById('youth-cnic-back');
const youthApplicantPicInput = document.getElementById('youth-applicant-pic');
const youthEducationInput = document.getElementById('youth-education');
const youthWorkInput = document.getElementById('youth-work');
const youthMobileInput = document.getElementById('youth-mobile');
const youthCnicNumberInput = document.getElementById('youth-cnic-number');

const gharLoanPage = document.getElementById('ghar-loan-page');
const gharLoanForm = document.getElementById('ghar-loan-form');
const gharCnicFrontInput = document.getElementById('ghar-cnic-front');
const gharCnicBackInput = document.getElementById('ghar-cnic-back');
const gharRelativeCnicFrontInput = document.getElementById('ghar-relative-cnic-front');
const gharMobile1Input = document.getElementById('ghar-mobile1');
const gharMobile2Input = document.getElementById('ghar-mobile2');
const gharPlotRegistryInput = document.getElementById('ghar-plot-registry');
const gharCnicNumberInput = document.getElementById('ghar-cnic-number');

const trackerPage = document.getElementById('tracker-page');
const trackerCnicInput = document.getElementById('tracker-cnic');
const trackerSearchBtn = document.getElementById('tracker-search-btn');
const trackerResultsDiv = document.getElementById('tracker-results');

const analyticsPage = document.getElementById('analytics-page');
const appViewsSpan = document.getElementById('app-views');
const appLikesSpan = document.getElementById('app-likes');
const likeBtn = document.getElementById('like-btn');
const ratingStarsDiv = document.getElementById('rating-stars');
const userRatingDisplay = document.getElementById('user-rating-display');
const feedbackTextarea = document.getElementById('feedback-text');
const submitFeedbackBtn = document.getElementById('submit-feedback-btn');
const feedbackStatusDiv = document.getElementById('feedback-status');

const eligibilityPage = document.getElementById('eligibility-page');
const aboutPage = document.getElementById('about-page');

// Admin related DOM elements
const hamburgerMenu = document.getElementById('hamburger-menu');
const sideNav = document.getElementById('side-nav');
const closeSideNav = document.getElementById('close-side-nav');
const sideNavAdmin = document.getElementById('side-nav-admin');
const sideNavAbout = document.getElementById('side-nav-about');
const sideNavLogout = document.getElementById('side-nav-logout');

const adminLoginPage = document.getElementById('admin-login-modal');
const adminPasswordInput = document.getElementById('admin-password-input');
const adminLoginBtn = document.getElementById('admin-login-btn');
const adminLoginError = document.getElementById('admin-login-error');
const closeAdminModal = document.getElementById('close-admin-modal');

const adminPage = document.getElementById('admin-page');
const adminApplicationsDiv = document.getElementById('admin-applications');
const adminLogoutBtn = document.getElementById('admin-logout-btn');

const navWelcome = document.getElementById('nav-welcome');
const navEligibility = document.getElementById('nav-eligibility');
const navAnalytics = document.getElementById('nav-analytics');
const navTracker = document.getElementById('nav-tracker');
const footerNav = document.getElementById('footer-nav');

// Loading and popup elements
const loadingOverlay = document.getElementById('loading-overlay');
const successPopup = document.getElementById('success-popup');
const popupMessage = document.getElementById('popup-message');
const closePopup = document.getElementById('close-popup');

let currentUser = null;
let isAdminLoggedIn = false;

// --- Utility Functions ---
function showPage(pageElement) {
    document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
    pageElement.style.display = 'block';
    closeNav();
}

function showLoading() {
    loadingOverlay.style.display = 'flex';
}

function hideLoading() {
    loadingOverlay.style.display = 'none';
}

function showSuccessPopup(message) {
    popupMessage.textContent = message;
    successPopup.style.display = 'flex';
    setTimeout(() => {
        successPopup.style.display = 'none';
    }, 3000);
}

closePopup.addEventListener('click', () => {
    successPopup.style.display = 'none';
});

async function uploadImageToCloudinary(file) {
    if (!file) return null;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    formData.append('api_key', CLOUDINARY_API_KEY);

    try {
        const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        if (data.secure_url) {
            return data.secure_url;
        } else {
            throw new Error('Cloudinary upload failed: ' + (data.error ? data.error.message : 'Unknown error'));
        }
    } catch (error) {
        console.error("Error uploading to Cloudinary:", error);
        return null;
    }
}

// --- Side Navigation and Admin Logic ---
function openNav() {
    sideNav.style.width = "250px";
    if (currentUser || isAdminLoggedIn) {
        sideNavLogout.style.display = 'block';
    } else {
        sideNavLogout.style.display = 'none';
    }
}

function closeNav() {
    sideNav.style.width = "0";
}

hamburgerMenu.addEventListener('click', openNav);
closeSideNav.addEventListener('click', closeNav);

sideNavAdmin.addEventListener('click', () => {
    closeNav();
    adminLoginPage.style.display = 'flex';
    adminPasswordInput.value = '';
    adminLoginError.style.display = 'none';
    setTimeout(() => adminLoginPage.classList.add('show'), 10);
});

sideNavAbout.addEventListener('click', () => {
    closeNav();
    showPage(aboutPage);
});

closeAdminModal.addEventListener('click', () => {
    adminLoginPage.classList.remove('show');
    setTimeout(() => adminLoginPage.style.display = 'none', 300);
});

adminLoginBtn.addEventListener('click', () => {
    const enteredPassword = adminPasswordInput.value;
    if (enteredPassword === ADMIN_PASSWORD) {
        isAdminLoggedIn = true;
        localStorage.setItem('isAdminLoggedIn', 'true');
        adminLoginPage.classList.remove('show');
        setTimeout(() => adminLoginPage.style.display = 'none', 300);
        showPage(adminPage);
        loadAdminApplications();
        footerNav.style.display = 'none'; // Hide footer for admin
    } else {
        adminLoginError.textContent = 'Incorrect password.';
        adminLoginError.style.display = 'block';
    }
});

adminLogoutBtn.addEventListener('click', () => {
    isAdminLoggedIn = false;
    localStorage.removeItem('isAdminLoggedIn');
    showSuccessPopup('Admin logged out.');
    checkUserStatus();
});

sideNavLogout.addEventListener('click', () => {
    if (isAdminLoggedIn) {
        adminLogoutBtn.click();
    } else if (currentUser) {
        navLogoutUser();
    }
    closeNav();
});

// --- User Authentication Logic ---
function checkUserStatus() {
    const storedUser = localStorage.getItem('currentUser');
    const storedAdminStatus = localStorage.getItem('isAdminLoggedIn');

    document.querySelectorAll('.page').forEach(page => page.style.display = 'none');

    if (storedAdminStatus === 'true') {
        isAdminLoggedIn = true;
        showPage(adminPage);
        loadAdminApplications();
        sideNavAdmin.style.display = 'none';
        sideNavLogout.style.display = 'block';
        footerNav.style.display = 'none'; // Hide footer for admin
        return;
    }

    if (storedUser) {
        currentUser = JSON.parse(storedUser);
        showPage(welcomePage);
        startImageSlider();
        incrementAppViews();
        sideNavAdmin.style.display = 'block';
        sideNavLogout.style.display = 'block';
        footerNav.style.display = 'flex'; // Show footer for logged in users
    } else {
        currentUser = null;
        isAdminLoggedIn = false;
        showPage(authPage);
        showRegisterSection();
        sideNavAdmin.style.display = 'block';
        sideNavLogout.style.display = 'none';
        footerNav.style.display = 'none'; // Hide footer for non-logged in users
    }
}

function navLogoutUser() {
    localStorage.removeItem('currentUser');
    currentUser = null;
    showSuccessPopup('Logged out successfully.');
    checkUserStatus();
}

function showRegisterSection() {
    registerSection.style.display = 'block';
    loginSection.style.display = 'none';
}

function showLoginSection() {
    registerSection.style.display = 'none';
    loginSection.style.display = 'block';
}

registerBtn.addEventListener('click', async () => {
    const username = registerUsernameInput.value.trim();
    const email = registerEmailInput.value.trim();
    const password = registerPasswordInput.value.trim();

    if (!username || !email || !password) {
        showSuccessPopup("Please fill in all registration fields.");
        return;
    }

    showLoading();
    try {
        const snapshot = await database.ref('users').orderByChild('email').equalTo(email).once('value');
        if (snapshot.exists()) {
            showSuccessPopup("This email is already registered. Please login or use a different email.");
            hideLoading();
            return;
        }

        const userRef = database.ref('users').push();
        await userRef.set({
            username: username,
            email: email,
            password: password
        });
        
        showSuccessPopup("Registration successful! Please login.");
        registerUsernameInput.value = '';
        registerEmailInput.value = '';
        registerPasswordInput.value = '';
        showLoginSection();
    } catch (error) {
        console.error("Registration error:", error);
        showSuccessPopup("Registration failed. Please try again.");
    } finally {
        hideLoading();
    }
});

loginBtn.addEventListener('click', async () => {
    const email = loginEmailInput.value.trim();
    const password = loginPasswordInput.value.trim();

    if (!email || !password) {
        showSuccessPopup("Please enter both email and password.");
        return;
    }

    showLoading();
    try {
        const usersRef = database.ref('users');
        const snapshot = await usersRef.orderByChild('email').equalTo(email).once('value');
        const userData = snapshot.val();

        if (userData) {
            const userId = Object.keys(userData)[0];
            const user = userData[userId];

            if (user.password === password) {
                currentUser = { uid: userId, username: user.username, email: user.email };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                loginEmailInput.value = '';
                loginPasswordInput.value = '';
                checkUserStatus();
            } else {
                showSuccessPopup("Incorrect password.");
            }
        } else {
            showSuccessPopup("User not found. Please register.");
        }
    } catch (error) {
        console.error("Login error:", error);
        showSuccessPopup("Login failed. Please try again.");
    } finally {
        hideLoading();
    }
});

showLoginLink.addEventListener('click', showLoginSection);
showRegisterLink.addEventListener('click', showRegisterSection);

// --- Welcome Page Slider ---
const sliderImages = [
    'download.webp',
    'happy.webp'
];
let currentImageIndex = 0;
let sliderInterval;

function startImageSlider() {
    clearInterval(sliderInterval);
    sliderInterval = setInterval(() => {
        currentImageIndex = (currentImageIndex + 1) % sliderImages.length;
        sliderImage.style.opacity = 0;
        setTimeout(() => {
            sliderImage.src = sliderImages[currentImageIndex];
            sliderImage.style.opacity = 1;
        }, 1000);
    }, 5000);
}

// --- Loan Application Logic ---
youthBusinessLoanCard.addEventListener('click', () => {
    if (!currentUser) {
        showSuccessPopup("Please login to apply for a loan.");
        showPage(authPage);
        return;
    }
    showPage(youthLoanPage);
});

apnaGharApniChatLoanCard.addEventListener('click', () => {
    if (!currentUser) {
        showSuccessPopup("Please login to apply for a loan.");
        showPage(authPage);
        return;
    }
    showPage(gharLoanPage);
});

youthLoanForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) {
        showSuccessPopup("Session expired. Please login to apply for a loan.");
        showPage(authPage);
        return;
    }

    showLoading();
    
    try {
        const cnicFrontFile = youthCnicFrontInput.files[0];
        const cnicBackFile = youthCnicBackInput.files[0];
        const applicantPicFile = youthApplicantPicInput.files[0];

        // First store text data
        const applicationData = {
            userId: currentUser.uid,
            username: currentUser.username,
            email: currentUser.email,
            loanType: 'Youth Business Loan',
            education: youthEducationInput.value.trim(),
            work: youthWorkInput.value.trim(),
            mobileNumber: youthMobileInput.value.trim(),
            cnicNumber: youthCnicNumberInput.value.trim(),
            status: 'Pending',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            cnicFrontUrl: 'uploading',
            cnicBackUrl: 'uploading',
            applicantPicUrl: 'uploading'
        };

        const newApplicationRef = database.ref('applications').push();
        await newApplicationRef.set(applicationData);

        // Upload images
        const [cnicFrontUrl, cnicBackUrl, applicantPicUrl] = await Promise.all([
            uploadImageToCloudinary(cnicFrontFile),
            uploadImageToCloudinary(cnicBackFile),
            uploadImageToCloudinary(applicantPicFile)
        ]);

        // Update with image URLs
        await newApplicationRef.update({
            cnicFrontUrl: cnicFrontUrl || 'failed',
            cnicBackUrl: cnicBackUrl || 'failed',
            applicantPicUrl: applicantPicUrl || 'failed'
        });

        showSuccessPopup("Youth Business Loan application submitted successfully!");
        youthLoanForm.reset();
        showPage(welcomePage);
    } catch (error) {
        console.error("Error submitting youth loan application:", error);
        showSuccessPopup("Error submitting application. Please try again.");
    } finally {
        hideLoading();
    }
});

gharLoanForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) {
        showSuccessPopup("Session expired. Please login to apply for a loan.");
        showPage(authPage);
        return;
    }

    showLoading();
    
    try {
        const cnicFrontFile = gharCnicFrontInput.files[0];
        const cnicBackFile = gharCnicBackInput.files[0];
        const relativeCnicFrontFile = gharRelativeCnicFrontInput.files[0];
        const plotRegistryFile = gharPlotRegistryInput.files[0];

        // First store text data
        const applicationData = {
            userId: currentUser.uid,
            username: currentUser.username,
            email: currentUser.email,
            loanType: 'Apna Ghar Apni Chat Loan',
            mobileNumber1: gharMobile1Input.value.trim(),
            mobileNumber2: gharMobile2Input.value.trim(),
            cnicNumber: gharCnicNumberInput.value.trim(),
            status: 'Pending',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            cnicFrontUrl: 'uploading',
            cnicBackUrl: 'uploading',
            relativeCnicFrontUrl: 'uploading',
            plotRegistryUrl: 'uploading'
        };

        const newApplicationRef = database.ref('applications').push();
        await newApplicationRef.set(applicationData);

        // Upload images
        const [cnicFrontUrl, cnicBackUrl, relativeCnicFrontUrl, plotRegistryUrl] = await Promise.all([
            uploadImageToCloudinary(cnicFrontFile),
            uploadImageToCloudinary(cnicBackFile),
            uploadImageToCloudinary(relativeCnicFrontFile),
            uploadImageToCloudinary(plotRegistryFile)
        ]);

        // Update with image URLs
        await newApplicationRef.update({
            cnicFrontUrl: cnicFrontUrl || 'failed',
            cnicBackUrl: cnicBackUrl || 'failed',
            relativeCnicFrontUrl: relativeCnicFrontUrl || 'failed',
            plotRegistryUrl: plotRegistryUrl || 'failed'
        });

        showSuccessPopup("Apna Ghar Apni Chat Loan application submitted successfully!");
        gharLoanForm.reset();
        showPage(welcomePage);
    } catch (error) {
        console.error("Error submitting ghar loan application:", error);
        showSuccessPopup("Error submitting application. Please try again.");
    } finally {
        hideLoading();
    }
});

// --- Application Tracker Logic ---
trackerSearchBtn.addEventListener('click', async () => {
    const cnic = trackerCnicInput.value.trim();
    if (!cnic) {
        showSuccessPopup("Please enter your CNIC number to track your application.");
        return;
    }

    showLoading();
    trackerResultsDiv.innerHTML = '<p>Searching...</p>';

    try {
        const snapshot = await database.ref('applications').orderByChild('cnicNumber').equalTo(cnic).once('value');
        const applications = snapshot.val();
        trackerResultsDiv.innerHTML = '';

        if (applications) {
            Object.keys(applications).forEach(appId => {
                const app = applications[appId];
                const appDiv = document.createElement('div');
                appDiv.classList.add('application-result');
                appDiv.innerHTML = `
                    <h4>Applicant: ${app.username}</h4>
                    <p><strong>Loan Type:</strong> ${app.loanType}</p>
                    <p><strong>Mobile:</strong> ${app.mobileNumber || app.mobileNumber1}</p>
                    <p><strong>CNIC:</strong> ${app.cnicNumber}</p>
                    <p><strong>Status:</strong> <span class="status-${app.status.toLowerCase()}">${app.status}</span></p>
                    <p><strong>Submitted:</strong> ${new Date(app.timestamp).toLocaleString()}</p>
                `;
                trackerResultsDiv.appendChild(appDiv);
            });
        } else {
            trackerResultsDiv.innerHTML = '<p>No applications found for this CNIC number.</p>';
        }
    } catch (error) {
        console.error("Error fetching applications:", error);
        trackerResultsDiv.innerHTML = '<p>Error searching for applications.</p>';
    } finally {
        hideLoading();
    }
});

// --- Analytics Logic ---
async function initializeAnalytics() {
    const analyticsRef = database.ref('analytics');
    const snapshot = await analyticsRef.once('value');
    if (!snapshot.exists()) {
        await analyticsRef.set({
            views: 0,
            likes: 0,
            ratings: {
                total: 0,
                count: 0
            },
            feedback: {}
        });
    }
    loadAnalyticsData();
}

function loadAnalyticsData() {
    const analyticsRef = database.ref('analytics');
    analyticsRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            appViewsSpan.textContent = data.views || 0;
            appLikesSpan.textContent = data.likes || 0;
            updateRatingDisplay(data.ratings ? data.ratings.total : 0, data.ratings ? data.ratings.count : 0);
        }
    });
}

function incrementAppViews() {
    const analyticsRef = database.ref('analytics/views');
    analyticsRef.transaction((currentViews) => {
        return (currentViews || 0) + 1;
    });
}

likeBtn.addEventListener('click', async () => {
    const analyticsRef = database.ref('analytics/likes');
    analyticsRef.transaction((currentLikes) => {
        return (currentLikes || 0) + 1;
    });
    showSuccessPopup('Thanks for liking our app!');
});

ratingStarsDiv.addEventListener('click', async (e) => {
    if (e.target.classList.contains('star')) {
        const rating = parseInt(e.target.dataset.value);
        const analyticsRatingsRef = database.ref('analytics/ratings');

        analyticsRatingsRef.transaction((currentRatings) => {
            const newRatings = currentRatings || { total: 0, count: 0 };
            newRatings.total += rating;
            newRatings.count += 1;
            return newRatings;
        }, (error, committed, snapshot) => {
            if (error) {
                console.error("Rating update failed: ", error);
            } else if (committed) {
                const data = snapshot.val();
                updateRatingDisplay(data.total, data.count);
                showSuccessPopup(`You rated ${rating} stars!`);
            }
        });

        document.querySelectorAll('.star').forEach(star => {
            if (parseInt(star.dataset.value) <= rating) {
                star.classList.add('selected');
            } else {
                star.classList.remove('selected');
            }
        });
    }
});

function updateRatingDisplay(total, count) {
    if (count > 0) {
        const averageRating = (total / count).toFixed(1);
        userRatingDisplay.textContent = `${averageRating} / 5 (${count} ratings)`;
    } else {
        userRatingDisplay.textContent = 'Not Rated Yet';
    }
}

submitFeedbackBtn.addEventListener('click', async () => {
    const feedback = feedbackTextarea.value.trim();
    if (!feedback) {
        showSuccessPopup("Please enter your feedback.");
        return;
    }
    if (!currentUser) {
        showSuccessPopup("Please login to submit feedback.");
        return;
    }

    showLoading();
    try {
        const feedbackRef = database.ref('analytics/feedback').push();
        await feedbackRef.set({
            userId: currentUser.uid,
            username: currentUser.username,
            feedback: feedback,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        feedbackStatusDiv.textContent = "Feedback submitted successfully!";
        feedbackStatusDiv.style.color = 'var(--accent-color)';
        feedbackTextarea.value = '';
        setTimeout(() => feedbackStatusDiv.textContent = '', 3000);
    } catch (error) {
        console.error("Error submitting feedback:", error);
        feedbackStatusDiv.textContent = "Error submitting feedback.";
        feedbackStatusDiv.style.color = 'var(--danger-color)';
    } finally {
        hideLoading();
    }
});

// --- Admin Page Logic ---
function loadAdminApplications() {
    if (!isAdminLoggedIn) {
        adminApplicationsDiv.innerHTML = '<p>You do not have administrative access.</p>';
        return;
    }

    const applicationsRef = database.ref('applications');
    applicationsRef.on('value', (snapshot) => {
        adminApplicationsDiv.innerHTML = '';
        const applications = snapshot.val();
        if (applications) {
            const sortedApplications = Object.keys(applications).map(key => ({
                id: key,
                ...applications[key]
            })).sort((a, b) => b.timestamp - a.timestamp);

            sortedApplications.forEach(app => {
                const appItem = document.createElement('div');
                appItem.classList.add('application-item');
                appItem.innerHTML = `
                    <h4>${app.username} - ${app.loanType}</h4>
                    <p>Email: ${app.email}</p>
                    <p>Mobile: ${app.mobileNumber || app.mobileNumber1}</p>
                    <p>CNIC: ${app.cnicNumber || 'N/A'}</p>
                    <p>Status: <span id="status-${app.id}" class="status-${app.status.toLowerCase()}">${app.status}</span></p>
                    <p>Submitted: ${new Date(app.timestamp).toLocaleString()}</p>
                    <h5>Documents:</h5>
                    <ul>
                        <li><a href="${app.cnicFrontUrl}" target="_blank" class="document-link">CNIC Front</a></li>
                        <li><a href="${app.cnicBackUrl}" target="_blank" class="document-link">CNIC Back</a></li>
                        ${app.applicantPicUrl ? `<li><a href="${app.applicantPicUrl}" target="_blank" class="document-link">Applicant Photo</a></li>` : ''}
                        ${app.relativeCnicFrontUrl ? `<li><a href="${app.relativeCnicFrontUrl}" target="_blank" class="document-link">Relative CNIC Front</a></li>` : ''}
                        ${app.plotRegistryUrl ? `<li><a href="${app.plotRegistryUrl}" target="_blank" class="document-link">Plot Registry</a></li>` : ''}
                    </ul>
                    <button class="approve-btn" data-id="${app.id}" ${app.status !== 'Pending' ? 'disabled' : ''}>Approve</button>
                    <button class="reject-btn" data-id="${app.id}" ${app.status !== 'Pending' ? 'disabled' : ''}>Reject</button>
                `;
                adminApplicationsDiv.appendChild(appItem);
            });

            document.querySelectorAll('.approve-btn').forEach(button => {
                button.addEventListener('click', (e) => updateApplicationStatus(e.target.dataset.id, 'Approved'));
            });
            document.querySelectorAll('.reject-btn').forEach(button => {
                button.addEventListener('click', (e) => updateApplicationStatus(e.target.dataset.id, 'Rejected'));
            });

        } else {
            adminApplicationsDiv.innerHTML = '<p>No applications have been submitted yet.</p>';
        }
    });
}

async function updateApplicationStatus(appId, status) {
    if (!isAdminLoggedIn) {
        showSuccessPopup("Permission denied.");
        return;
    }
    showLoading();
    try {
        await database.ref(`applications/${appId}/status`).set(status);
        showSuccessPopup(`Application status updated to ${status}.`);
    } catch (error) {
        console.error("Error updating status:", error);
        showSuccessPopup("Failed to update application status.");
    } finally {
        hideLoading();
    }
}

// --- Footer Navigation ---
navWelcome.addEventListener('click', () => {
    if (currentUser) {
        showPage(welcomePage);
        startImageSlider();
    } else {
        showPage(authPage);
    }
});
navEligibility.addEventListener('click', () => showPage(eligibilityPage));
navAnalytics.addEventListener('click', () => {
    showPage(analyticsPage);
    loadAnalyticsData();
});
navTracker.addEventListener('click', () => showPage(trackerPage));

// --- Initial App Load ---
document.addEventListener('DOMContentLoaded', () => {
    checkUserStatus();
    initializeAnalytics();
});

    </script>
</body>
</html>
